<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{includes/header :: header}">
</head>
<body>

	<div th:replace="~{includes/sidebar2 :: sidebar2}"></div>
	
	<div class="wrapper d-flex flex-column min-vh-100 bg-light">
	
		<div th:replace="~{includes/subheader2 :: subheader2}"></div>
		
		<div class="body flex-grow-1 px-3">
			<div class="container-lg">
				<div class="row">
					<div class="card col-md-12 border-0 p-0">
						<div class="card-body bg-light border-0">
							<nav>
		                      <div class="nav nav-tabs d-flex" id="nav-tab" role="tablist">
		                        <button class="nav-link custom-tab active border-0" id="nav-home-tab" data-coreui-toggle="tab" 
		                        data-coreui-target="#nav-profile" type="button" role="tab" aria-controls="nav-profile" aria-selected="true">
		                        <i class="fa-regular fa-user"></i> Update Profile</button>
		                        
		                        <button class="nav-link custom-tab border-0" id="nav-pass-tab" data-coreui-toggle="tab" 
		                        data-coreui-target="#nav-pass" type="button" role="tab" aria-controls="nav-pass" aria-selected="false">
		                        <i class="fa-solid fa-lock"></i> Change Password</button>
		                      </div>
		                    </nav>
						</div>
					</div>
				</div>
				
				
				<div class="row justify-content-between">
					<div class="tab-content mt-3" id="nav-tabContent">
					
					<div class="tab-pane fade show active" id="nav-profile" role="tabpanel" aria-labelledby="nav-profile" tabindex="0">
					
					<form th:action="@{/admin/profile/update/{id}(id=${user.id})}" method="post" th:object="${user}" enctype="multipart/form-data">
					<input type="hidden" th:field="*{id}" th:value="${user.id}">
					<div class="card mb-4 p-0 col-md-12 height-min-content">
						<div class="card-body p-0 m-0">
							<div class="d-flex flex-wrap">
								<img class="profile-banner" src="/images/full.jpg" width="100%" height="100%">
							</div>
						</div>
						
					</div>
					<div class="card mb-4 col-md-12 border-0 bg-transparent align-items-center margin-minus-40">
						<div class="card-body width-min-content justify-self-center bg-white circle">
							<div class="col-md-12 text-center m-0" >
								
		                		<img class="profile-image" th:src="${user.imageUri != null ? user.imageUri : '/images/user.png' }" width="100%" height="100%">
		          				<input type="file" name="file" id="profileImg" th:value="${user.fileName}" class="btn btn-primary" hidden accept=".png,.jpg,.jpeg"/>
			                	<label for="profileImg" class="text-center cursor-pointer edit-profile">
			                		<i class="fa-solid fa-pen"></i>
			                	</label>
			              	</div>
						</div>
					</div>
					
					<div class="card mb-4 col-md-12">
						<div class="card-body">
							<div class="">
								<div class="row">
				                	<h5 class="card-title mb-1">Change user information here</h5>
				              	</div>
				              	<div class="row">
					              	<div class="col-md-4">
					              		<div class="mb-3">
			  								<label for="firstname" class="form-label">First Name</label>
			 								<input type="text" class="form-control" id="firstname"  
			 									placeholder="First Name" th:value="${user.firstName}" th:field="*{firstName}">
										</div>
									</div>
					              	<div class="col-md-4">
					              		<label for="middlename" class="form-label">Middle Name</label>
				 						<input type="text" class="form-control" id="middlename" 
				 							placeholder="Middle Name" th:value="${user.middleName}" th:field="*{middleName}" >
					              	</div>
					              	
					              	<div class="col-md-4">
					              		<div class="mb-3">
			  								<label for="lastname" class="form-label">Last Name</label>
			 								<input type="text" class="form-control" id="lastname"
			 								th:value="${user.lastName}" placeholder="Last Name" th:field="*{lastName}">
										</div>
									</div>
					             </div>
							</div>
							
							<div class="row">
								<div class="col-md-4">
									<div class="mb-3">
					              		<label for="address" class="form-label">Address</label>
				 						<input type="text" class="form-control" id="address" th:field="*{address}"
				 						 th:value="${user.address}" placeholder="Barangay/Street" >
				 					</div>
					             </div>
					             
					             <div class="col-md-4">
				              		<div class="mb-3">
		  								<label for="city" class="form-label">City/Municipality</label>
		 								<input type="text" class="form-control" id="city" th:field="*{userData.city}"
		 								 th:value="${user.userData.city}" placeholder="City/Municipality">
									</div>
								</div>
								
								<div class="col-md-4">
					            	<div class="mb-3">
						              	<label for="zip" class="form-label">Zip Code</label>
					 					<input type="text" class="form-control" id="zip" th:field="*{userData.zipCode}"
					 					th:value="${user.userData.zipCode}" placeholder="Zip Code">
				 					</div>
					            </div>
					             
							</div>
							
							<div class="row">
								
					            <div class="col-md-6">
					            	<div class="mb-3">
						              	<label for="state" class="form-label">State/Province</label>
					 					<input type="text" class="form-control" id="state" th:field="*{userData.province}"
					 					th:value="${user.userData.province}" placeholder="State/Province">
				 					</div>
					            </div>
					            
					            <div class="col-md-6">
					            	<div class="mb-3">
						              	<label for="country" class="form-label">Country</label>
					 					<input type="text" class="form-control" id="country" th:field="*{userData.country}"
					 					th:value="${user.userData.country}" placeholder="Country">
				 					</div>
					            </div>
					            
							</div>
							
							<div class="col-md-12 text-end">
								<input type="submit" value="Save Changes" class="btn btn-primary" />
							</div>
						</div>
					</div>
					</form>
					</div>
					
					
					<div class="tab-pane fade show" id="nav-pass" role="tabpanel" aria-labelledby="nav-pass-tab" tabindex="0">
						<form th:action="@{/admin/profile/update-password}" id="updatePassForm" method="post" th:object="${user}">
						<input type="hidden" th:value="${user.id}" th:field="*{id}" id="userid"/>
						<div class="card mb-4 col-md-12">
							<div class="card-body">
								<div class="row flex-column align-items-center">
					              	<div class="col-md-6 ">
					              		<div class="mb-3">
			  								<label for="email" class="form-label">Email</label>
			 								<input type="text" class="form-control" id="email" th:field="*{email}" th:value="${user.email}" placeholder="Email" disabled />
										</div>
									</div>
					              	<div class="col-md-6 mb-3" >
					              		<label for="old-password" class="form-label">Old Password</label>
				 						<input type="password" class="form-control form-control-c" id="old-password" placeholder="Old password" />
					              		<small id="passError" class="d-none">Old password don't match.</small>
					              	</div>
					              	
					              	<div class="col-md-6 mb-3">
					              		<label for="new-password" class="form-label">New Password</label>
				 						<input type="password" class="form-control form-control-c" id="new-password" 
				 							  th:field="*{password}" placeholder="password" />
					              		<small id="newPassError" class="d-none">New password don't match.</small>
					              	</div>
					              	
					              	<div class="col-md-6 mb-3">
					              		<label for="re-password" class="form-label">Re-type Password</label>
				 						<input type="password" class="form-control form-control-c" id="re-password" placeholder="password" />
					              	</div>
					              	
					              	<div class="col-md-6 ">
					              		<button type="button" id="savePassword" class="btn btn-primary">Save Changes</button>
					              	</div>
					             </div>
							</div>
						</div>
						</form>
					</div>
					
					</div>
					
				</div>
				
			</div>
		</div>
		
	</div>
	
	<script>
		jQuery(document).ready(function($){
			$('#savePassword').click(function(e){
				e.preventDefault();
				
				const oldPass = $('#old-password').val();
				const id =$('#userid').val();
				console.log(window.location.origin +'/ajax/verifyPassword/')
				if(oldPass != '' && id != ''){
					$.ajax({
                        url : window.location.origin +'/ajax/verifyPassword/',
                        type : 'GET',
                        data : {
                        	password : oldPass,
                        	userid : id
                        },
                        async: true,
                        dataType: 'json',
                        success : function(res){
                            if(res){
                            	if(validate()){
                            		showError();
                            	}else{
                            		$('#updatePassForm').submit();
                            	}
                            }else{
                            	jQuery('#old-password').addClass('is-invalid');
                            	if(validate()){
                            		showError();
                            	}
                            }
                        }
                    });
				}else{
					jQuery('#old-password').addClass('is-invalid');
					showError();
				}
			});
			
			$(".form-control-c").focus(function(){
				$(this).removeClass('is-invalid');
			});
			
		});
		
		function showError(){
			const oldPass = jQuery('#old-password');
			const newPass = jQuery('#new-password').val();
			const retypePass = jQuery('#re-password').val();
			
			if(newPass != retypePass || ( oldPass == '' || retypePass == '' ) ){
				jQuery('#newPassError').css('display' , 'block !important;');
				jQuery('#new-password').addClass('is-invalid');
				jQuery('#re-password').addClass('is-invalid');
			}
		}
		
		function validate(){
			const oldPass = jQuery('#old-password');
			const newPass = jQuery('#new-password').val();
			const retypePass = jQuery('#re-password').val();
			let error = false;
			if(newPass != retypePass || ( oldPass == '' || retypePass == '' ) ){
				error = true;
			}
			
			return error;
		}
		
	</script>
	
	<footer th:replace="~{includes/footer :: footer}"></footer>
</body>
</html>